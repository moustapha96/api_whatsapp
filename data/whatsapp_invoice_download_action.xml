<?xml version="1.0" encoding="utf-8"?>
<!-- Action pour t√©l√©charger le PDF d'une facture -->
<odoo>
    <!-- Action pour t√©l√©charger le PDF d'une facture -->
    <record id="action_btn_download_invoice" model="whatsapp.button.action">
        <field name="name">T√©l√©charger PDF facture</field>
        <field name="button_id">btn_download_invoice</field>
        <field name="action_type">custom_python</field>
        <field name="python_code"><![CDATA[
import base64

_logger.info("=== D√©but action t√©l√©chargement facture ===")
_logger.info("Button ID re√ßu: %s", button_id)
_logger.info("Message phone: %s", message.phone if message else 'N/A')

# Extrait l'ID de la facture depuis le button_id
invoice_id = None
invoice = None

# Le button_id est au format "btn_download_invoice_123" o√π 123 est l'ID de la facture
if button_id and button_id.startswith('btn_download_invoice_'):
    try:
        invoice_id_str = button_id.replace('btn_download_invoice_', '')
        invoice_id = int(invoice_id_str)
        invoice = env['account.move'].browse(invoice_id)
        if not invoice.exists():
            invoice = None
            _logger.warning("Facture avec ID %s n'existe pas (button_id: %s)", invoice_id, button_id)
        else:
            _logger.info("Facture trouv√©e par ID: %s (button_id: %s)", invoice.name, button_id)
    except ValueError as e:
        _logger.warning("Impossible de convertir l'ID de facture depuis button_id %s: %s", button_id, str(e))
        invoice = None
    except Exception as e:
        _logger.warning("Erreur lors de la recherche de facture par ID depuis button_id %s: %s", button_id, str(e))
        invoice = None

# Si pas trouv√© par ID, cherche par num√©ro de t√©l√©phone du partenaire
if not invoice:
    _logger.info("Facture non trouv√©e par ID, recherche par num√©ro de t√©l√©phone: %s", message.phone)
    phone_clean = message.phone.replace(' ', '').replace('-', '').replace('.', '')
    if not phone_clean.startswith('+'):
        phone_clean = '+' + phone_clean.lstrip('+')
    
    # Cherche d'abord avec le num√©ro exact
    invoice = env['account.move'].search([
        ('partner_id.phone', '=', phone_clean),
        ('move_type', 'in', ['out_invoice', 'out_refund']),
        ('state', '=', 'posted')
    ], order='create_date desc', limit=1)
    
    # Si pas trouv√©, cherche avec ilike (moins restrictif)
    if not invoice:
        invoice = env['account.move'].search([
            ('partner_id.phone', 'ilike', phone_clean),
            ('move_type', 'in', ['out_invoice', 'out_refund']),
            ('state', '=', 'posted')
        ], order='create_date desc', limit=1)
    
    if invoice:
        _logger.info("Facture trouv√©e par num√©ro de t√©l√©phone: %s", invoice.name)
    else:
        _logger.warning("Aucune facture trouv√©e pour le num√©ro %s", phone_clean)

if invoice:
    _logger.info("‚úÖ Facture trouv√©e: %s (ID: %s), Partenaire: %s (ID: %s)", 
               invoice.name, invoice.id, invoice.partner_id.name if invoice.partner_id else 'N/A', 
               invoice.partner_id.id if invoice.partner_id else 'N/A')
    try:
        # Essaie plusieurs m√©thodes pour trouver le rapport et g√©n√©rer le PDF
        pdf_content = None
        report_names = ['account.report_invoice', 'account.report_invoice_with_payments']
        
        # M√©thode 1 : Utilise _get_report_from_name
        for report_name in report_names:
            try:
                report = env['ir.actions.report']._get_report_from_name(report_name)
                if report and report.exists():
                    try:
                        pdf_content, _unused = report._render_qweb_pdf(invoice.id)
                        if pdf_content:
                            _logger.info("PDF g√©n√©r√© avec succ√®s via _get_report_from_name (%s)", report_name)
                            break
                    except Exception as e:
                        _logger.debug("Erreur lors de la g√©n√©ration PDF avec rapport %s: %s", report_name, str(e))
                        pdf_content = None
                        continue
            except Exception as e:
                _logger.debug("Erreur lors de la recherche du rapport %s: %s", report_name, str(e))
                continue
        
        # M√©thode 2 : Si pas de PDF, cherche directement dans la base
        if not pdf_content:
            try:
                report = env['ir.actions.report'].search([
                    ('report_name', 'in', report_names),
                    ('model', '=', 'account.move')
                ], limit=1)
                
                if report and report.exists():
                    try:
                        pdf_content, _unused = report._render_qweb_pdf(invoice.id)
                        if pdf_content:
                            _logger.info("PDF g√©n√©r√© avec succ√®s via recherche directe")
                    except Exception as e:
                        _logger.debug("Erreur lors de la g√©n√©ration PDF avec rapport trouv√©: %s", str(e))
                        pdf_content = None
            except Exception as e:
                _logger.debug("Erreur lors de la recherche directe du rapport: %s", str(e))
        
        # M√©thode 3 : Utilise _render_qweb_pdf directement avec le nom du rapport
        if not pdf_content:
            for report_name in report_names:
                try:
                    pdf_content, _unused = env['ir.actions.report']._render_qweb_pdf(report_name, invoice.id)
                    if pdf_content:
                        _logger.info("PDF g√©n√©r√© avec succ√®s via _render_qweb_pdf direct (%s)", report_name)
                        break
                except Exception as e:
                    _logger.debug("Erreur lors de la g√©n√©ration PDF directe avec %s: %s", report_name, str(e))
                    pdf_content = None
                    continue
        
        if pdf_content:
            try:
                # Cr√©e un attachment public pour le PDF
                attachment = env['ir.attachment'].create({
                    'name': f"{invoice.name}.pdf",
                    'type': 'binary',
                    'datas': base64.b64encode(pdf_content),
                    'res_model': 'account.move',
                    'res_id': invoice.id,
                    'public': True,  # Important : rend le fichier accessible publiquement
                })
                
                # G√©n√®re l'URL publique de t√©l√©chargement
                base_url = env['ir.config_parameter'].sudo().get_param('web.base.url')
                if not base_url:
                    _logger.warning("web.base.url non configur√©, impossible de g√©n√©rer l'URL de t√©l√©chargement")
                    pdf_url = None
                else:
                    pdf_url = f"{base_url}/web/content/{attachment.id}?download=true"
                    _logger.info("URL PDF g√©n√©r√©e: %s", pdf_url)
            except Exception as e:
                _logger.error("Erreur lors de la cr√©ation de l'attachement PDF: %s", str(e))
                pdf_url = None
            
            # Envoie le message avec le lien de t√©l√©chargement
            if pdf_url:
                config = message.config_id
                if not config:
                    # Essaie de r√©cup√©rer la configuration active
                    config = env['whatsapp.config'].search([('is_active', '=', True)], limit=1)
                    _logger.info("Configuration r√©cup√©r√©e depuis message.config_id: %s, depuis recherche: %s", 
                               message.config_id, config.id if config else None)
                
                if config:
                    download_message = f"üìÑ Voici le lien pour t√©l√©charger votre facture {invoice.name} :\n\n"
                    download_message += f"{pdf_url}\n\n"
                    download_message += f"Montant : {invoice.amount_total:.0f} F CFA"
                    
                    _logger.info("Tentative d'envoi du message de t√©l√©chargement pour la facture %s au partenaire %s (ID: %s)", 
                               invoice.name, invoice.partner_id.name, invoice.partner_id.id)
                    
                    try:
                        result = config.send_text_to_partner(
                            partner_id=invoice.partner_id.id,
                            message_text=download_message
                        )
                        
                        _logger.info("R√©sultat de l'envoi pour la facture %s: %s", invoice.name, result)
                        
                        if result and isinstance(result, dict) and result.get('success'):
                            _logger.info("‚úÖ Lien de t√©l√©chargement envoy√© avec succ√®s pour la facture %s", invoice.name)
                            message.content = f"Lien PDF facture {invoice.name} envoy√©"
                        else:
                            error_msg = result.get('error', 'Erreur inconnue') if isinstance(result, dict) else str(result)
                            _logger.warning("‚ùå √âchec de l'envoi du lien de t√©l√©chargement pour la facture %s: %s", invoice.name, error_msg)
                            message.content = f"√âchec envoi lien PDF facture {invoice.name}: {error_msg}"
                    except Exception as e:
                        _logger.exception("Erreur lors de l'envoi du message de t√©l√©chargement pour la facture %s", invoice.name)
                        message.content = f"Erreur envoi: {str(e)}"
                else:
                    _logger.error("‚ùå Configuration WhatsApp non trouv√©e pour envoyer le lien de t√©l√©chargement (message.config_id: %s)", 
                                message.config_id.id if message.config_id else None)
                    message.content = "Configuration WhatsApp non trouv√©e"
            else:
                # Pas d'URL, envoie quand m√™me un message avec les d√©tails de la facture
                _logger.warning("Impossible de g√©n√©rer l'URL PDF pour la facture %s, envoi message texte avec d√©tails", invoice.name)
                config = message.config_id
                if not config:
                    config = env['whatsapp.config'].search([('is_active', '=', True)], limit=1)
                
                if config:
                    details_message = f"üìÑ D√©tails de votre facture {invoice.name}\n\n"
                    details_message += f"Montant total : {invoice.amount_total:.0f} F CFA\n"
                    if invoice.invoice_date:
                        details_message += f"Date : {invoice.invoice_date.strftime('%d/%m/%Y')}\n"
                    details_message += "\nLe PDF n'est pas disponible pour le moment."
                    details_message += "\nVeuillez contacter le service client."
                    
                    try:
                        result = config.send_text_to_partner(
                            partner_id=invoice.partner_id.id,
                            message_text=details_message
                        )
                        if result and isinstance(result, dict) and result.get('success'):
                            _logger.info("Message texte avec d√©tails envoy√© pour la facture %s", invoice.name)
                            message.content = f"D√©tails facture {invoice.name} envoy√©s (sans PDF)"
                        else:
                            _logger.warning("√âchec envoi message texte pour facture %s", invoice.name)
                            message.content = f"Erreur envoi d√©tails facture {invoice.name}"
                    except Exception as e:
                        _logger.exception("Erreur lors de l'envoi du message texte pour la facture %s", invoice.name)
                        message.content = f"Erreur envoi: {str(e)}"
                else:
                    message.content = "Configuration WhatsApp non trouv√©e"
        else:
            # Impossible de g√©n√©rer le PDF, envoie quand m√™me un message avec les d√©tails
            _logger.warning("Impossible de g√©n√©rer le PDF pour la facture %s (aucune m√©thode n'a fonctionn√©), envoi message texte avec d√©tails", invoice.name)
            config = message.config_id
            if not config:
                config = env['whatsapp.config'].search([('is_active', '=', True)], limit=1)
            
            if config:
                details_message = f"üìÑ D√©tails de votre facture {invoice.name}\n\n"
                details_message += f"Montant total : {invoice.amount_total:.0f} F CFA\n"
                if invoice.invoice_date:
                    details_message += f"Date : {invoice.invoice_date.strftime('%d/%m/%Y')}\n"
                details_message += "\nLe PDF n'est pas disponible pour le moment."
                details_message += "\nVeuillez contacter le service client."
                
                try:
                    result = config.send_text_to_partner(
                        partner_id=invoice.partner_id.id,
                        message_text=details_message
                    )
                    if result and isinstance(result, dict) and result.get('success'):
                        _logger.info("Message texte avec d√©tails envoy√© pour la facture %s (PDF non disponible)", invoice.name)
                        message.content = f"D√©tails facture {invoice.name} envoy√©s (sans PDF)"
                    else:
                        _logger.warning("√âchec envoi message texte pour facture %s", invoice.name)
                        message.content = f"Erreur envoi d√©tails facture {invoice.name}"
                except Exception as e:
                    _logger.exception("Erreur lors de l'envoi du message texte pour la facture %s", invoice.name)
                    message.content = f"Erreur envoi: {str(e)}"
            else:
                message.content = "Configuration WhatsApp non trouv√©e"
    except Exception as e:
        _logger.error("Erreur lors de la g√©n√©ration et envoi du PDF pour la facture %s: %s", invoice.name, str(e))
        message.content = f"Erreur g√©n√©ration PDF: {str(e)}"
else:
    _logger.warning("‚ùå Aucune facture trouv√©e pour t√©l√©chargement via WhatsApp - Bouton: %s, Num√©ro: %s", button_id, message.phone if message else 'N/A')
    message.content = "Aucune facture trouv√©e pour t√©l√©chargement"

_logger.info("=== Fin action t√©l√©chargement facture ===")
]]></field>
        <field name="sequence">10</field>
        <field name="active">True</field>
        <field name="description">Envoie le lien de t√©l√©chargement du PDF d'une facture lorsque le client clique sur "T√©l√©charger PDF"</field>
    </record>
</odoo>

