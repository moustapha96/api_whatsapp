<?xml version="1.0" encoding="utf-8"?>
<!-- Actions de boutons pour le paiement de factures via WhatsApp -->
<odoo>
    <!-- Action pour afficher les options de paiement (Wave/Orange Money) -->
    <record id="action_btn_pay_invoice" model="whatsapp.button.action">
        <field name="name">Payer facture</field>
        <field name="button_id">btn_pay_invoice</field>
        <field name="action_type">custom_python</field>
        <field name="python_code"><![CDATA[
# Extrait l'ID de la facture depuis le button_id
invoice_id = None
invoice = None

# Le button_id est au format "btn_pay_invoice_123" oÃ¹ 123 est l'ID de la facture
if button_id and button_id.startswith('btn_pay_invoice_'):
    try:
        invoice_id_str = button_id.replace('btn_pay_invoice_', '')
        invoice_id = int(invoice_id_str)
        invoice = env['account.move'].browse(invoice_id)
        if not invoice.exists():
            invoice = None
            _logger.warning("Facture avec ID %s n'existe pas (button_id: %s)", invoice_id, button_id)
        else:
            _logger.info("Facture trouvÃ©e par ID: %s (button_id: %s)", invoice.name, button_id)
    except ValueError as e:
        _logger.warning("Impossible de convertir l'ID de facture depuis button_id %s: %s", button_id, str(e))
        invoice = None
    except Exception as e:
        _logger.warning("Erreur lors de la recherche de facture par ID depuis button_id %s: %s", button_id, str(e))
        invoice = None

# Si pas trouvÃ© par ID, cherche par numÃ©ro de tÃ©lÃ©phone du partenaire
if not invoice:
    phone_clean = message.phone.replace(' ', '').replace('-', '').replace('.', '')
    if not phone_clean.startswith('+'):
        phone_clean = '+' + phone_clean.lstrip('+')
    
    invoice = env['account.move'].search([
        ('partner_id.phone', 'ilike', phone_clean),
        ('move_type', 'in', ['out_invoice', 'out_refund']),
        ('state', '=', 'posted'),
        ('amount_residual', '>', 0)
    ], order='create_date desc', limit=1)

if invoice:
    # VÃ©rifie si les attributs de paiement existent (module res_api_rental)
    has_payment_links = hasattr(invoice, 'payment_link_wave') and hasattr(invoice, 'payment_link_orange_money')
    
    # S'assure que les liens de paiement existent si les attributs sont disponibles
    if has_payment_links:
        if hasattr(invoice, '_ensure_payment_links'):
            invoice._ensure_payment_links()
        elif not getattr(invoice, 'payment_link_wave', None) or not getattr(invoice, 'payment_link_orange_money', None):
            if hasattr(invoice, 'transaction_id') and invoice.transaction_id:
                base_url = env['ir.config_parameter'].sudo().get_param('web.base.url', '')
                if not getattr(invoice, 'payment_link_wave', None):
                    invoice.payment_link_wave = f"{base_url}/paiement?type=wave&transaction={invoice.transaction_id}"
                if not getattr(invoice, 'payment_link_orange_money', None):
                    invoice.payment_link_orange_money = f"{base_url}/paiement?type=orange&transaction={invoice.transaction_id}"
    
    # Envoie un message avec les options de paiement
    if message.config_id:
        payment_message = f"ðŸ’³ Options de paiement pour la facture {invoice.name}\n\n"
        payment_message += f"Montant Ã  payer : {invoice.amount_residual:.0f} {invoice.currency_id.symbol}\n\n"
        payment_message += "Choisissez votre mÃ©thode de paiement :"
        
        # CrÃ©e deux boutons : Wave et Orange Money (seulement si les attributs existent)
        buttons = []
        if has_payment_links:
            payment_link_wave = getattr(invoice, 'payment_link_wave', None)
            payment_link_orange = getattr(invoice, 'payment_link_orange_money', None)
            
            if payment_link_wave:
                buttons.append({
                    "type": "reply",
                    "reply": {
                        "id": f"btn_pay_wave_{invoice.id}",
                        "title": "Payer Wave"  # Limite WhatsApp: 20 caractÃ¨res max
                    }
                })
            if payment_link_orange:
                buttons.append({
                    "type": "reply",
                    "reply": {
                        "id": f"btn_pay_orange_{invoice.id}",
                        "title": "Payer Orange"  # Limite WhatsApp: 20 caractÃ¨res max (Ã©tait 22)
                    }
                })
        
        # WhatsApp exige entre 1 et 3 boutons pour les messages interactifs
        if len(buttons) > 0:
            # Envoie un message interactif avec les boutons
            result = message.config_id.send_interactive_message(
                to_phone=message.phone,
                body_text=payment_message,
                buttons=buttons
            )
            
            if result and isinstance(result, dict) and result.get('success'):
                _logger.info("Options de paiement envoyÃ©es pour la facture %s", invoice.name)
                message.content = f"Options de paiement facture {invoice.name} envoyÃ©es"
            else:
                _logger.warning("Ã‰chec de l'envoi des options de paiement pour la facture %s", invoice.name)
                message.content = f"Ã‰chec envoi options paiement: {result.get('error', 'Erreur inconnue') if result else 'Aucun rÃ©sultat'}"
        else:
            # Si aucun bouton disponible, envoie un message texte avec les liens
            _logger.warning("Aucun lien de paiement disponible pour la facture %s, envoi message texte", invoice.name)
            payment_message += "\n\nAucune option de paiement en ligne disponible pour le moment."
            payment_message += "\nVeuillez contacter le service client pour rÃ©gler cette facture."
            
            result = message.config_id.send_text_to_partner(
                partner_id=invoice.partner_id.id,
                message_text=payment_message
            )
            
            if result and isinstance(result, dict) and result.get('success'):
                _logger.info("Message de paiement (texte) envoyÃ© pour la facture %s", invoice.name)
                message.content = f"Message paiement facture {invoice.name} envoyÃ© (sans options)"
            else:
                _logger.warning("Ã‰chec de l'envoi du message de paiement pour la facture %s", invoice.name)
                message.content = f"Ã‰chec envoi message: {result.get('error', 'Erreur inconnue') if result else 'Aucun rÃ©sultat'}"
    else:
        _logger.warning("Configuration WhatsApp non trouvÃ©e pour envoyer les options de paiement")
        message.content = "Configuration WhatsApp non trouvÃ©e"
else:
    _logger.warning("Aucune facture trouvÃ©e pour paiement via WhatsApp - Bouton: %s, NumÃ©ro: %s", button_id, message.phone)
    message.content = "Aucune facture trouvÃ©e"
]]></field>
        <field name="sequence">10</field>
        <field name="active">True</field>
        <field name="description">Affiche les options de paiement (Wave/Orange Money) lorsque le client clique sur "Payer"</field>
    </record>
    
    <!-- Action pour envoyer le lien de paiement Wave -->
    <record id="action_btn_pay_wave" model="whatsapp.button.action">
        <field name="name">Payer avec Wave</field>
        <field name="button_id">btn_pay_wave</field>
        <field name="action_type">custom_python</field>
        <field name="python_code"><![CDATA[
# Extrait l'ID de la facture depuis le button_id
invoice_id = None
invoice = None

# Le button_id est au format "btn_pay_wave_123" oÃ¹ 123 est l'ID de la facture
if button_id and button_id.startswith('btn_pay_wave_'):
    try:
        invoice_id_str = button_id.replace('btn_pay_wave_', '')
        invoice_id = int(invoice_id_str)
        invoice = env['account.move'].browse(invoice_id)
        if not invoice.exists():
            invoice = None
            _logger.warning("Facture avec ID %s n'existe pas (button_id: %s)", invoice_id, button_id)
        else:
            _logger.info("Facture trouvÃ©e par ID: %s (button_id: %s)", invoice.name, button_id)
    except ValueError as e:
        _logger.warning("Impossible de convertir l'ID de facture depuis button_id %s: %s", button_id, str(e))
        invoice = None
    except Exception as e:
        _logger.warning("Erreur lors de la recherche de facture par ID depuis button_id %s: %s", button_id, str(e))
        invoice = None

# Si pas trouvÃ© par ID, cherche par numÃ©ro de tÃ©lÃ©phone du partenaire
if not invoice:
    phone_clean = message.phone.replace(' ', '').replace('-', '').replace('.', '')
    if not phone_clean.startswith('+'):
        phone_clean = '+' + phone_clean.lstrip('+')
    
    invoice = env['account.move'].search([
        ('partner_id.phone', 'ilike', phone_clean),
        ('move_type', 'in', ['out_invoice', 'out_refund']),
        ('state', '=', 'posted'),
        ('amount_residual', '>', 0)
    ], order='create_date desc', limit=1)

if invoice:
    # VÃ©rifie si les attributs de paiement existent
    has_payment_links = hasattr(invoice, 'payment_link_wave') and hasattr(invoice, 'payment_link_orange_money')
    
    # S'assure que le lien Wave existe si les attributs sont disponibles
    payment_link_wave = None
    if has_payment_links:
        if hasattr(invoice, '_ensure_payment_links'):
            invoice._ensure_payment_links()
        elif not getattr(invoice, 'payment_link_wave', None):
            if hasattr(invoice, 'transaction_id') and invoice.transaction_id:
                base_url = env['ir.config_parameter'].sudo().get_param('web.base.url', '')
                invoice.payment_link_wave = f"{base_url}/paiement?type=wave&transaction={invoice.transaction_id}"
        
        payment_link_wave = getattr(invoice, 'payment_link_wave', None)
    
    if payment_link_wave:
        # Essaie d'abord d'utiliser un template WhatsApp avec bouton URL
        # Si le template n'est pas disponible, utilise un message texte
        if message.config_id:
            try:
                # Essaie d'envoyer avec le template "paiement_wave"
                components = [
                    {
                        "type": "body",
                        "parameters": [
                            {"type": "text", "text": invoice.name},  # {{1}} - NumÃ©ro facture
                            {"type": "text", "text": f"{invoice.amount_residual:.0f}"},  # {{2}} - Montant
                            {"type": "text", "text": invoice.currency_id.symbol or "CFA"}  # {{3}} - Devise
                        ]
                    },
                    {
                        "type": "button",
                        "sub_type": "url",
                        "index": "0",  # Index du premier bouton (0-based)
                        "parameters": [
                            {
                                "type": "text",
                                "text": invoice.payment_link_wave  # {{4}} - URL de paiement
                            }
                        ]
                    }
                ]
                
                result = message.config_id.send_template_message(
                    to_phone=message.phone,
                    template_name="paiement_wave",
                    language_code="fr",
                    components=components
                )
                
                if result and isinstance(result, dict) and result.get('success'):
                    _logger.info("Template paiement_wave envoyÃ© avec succÃ¨s pour la facture %s", invoice.name)
                    message.content = f"Template Wave facture {invoice.name} envoyÃ©"
                else:
                    raise Exception("Template non disponible ou erreur")
                    
            except Exception as e:
                _logger.info("Template paiement_wave non disponible, utilisation message texte: %s", str(e))
                # Fallback : message texte avec lien cliquable
                wave_message = f"ðŸ’³ Paiement Wave pour la facture {invoice.name}\n\n"
                wave_message += f"Montant Ã  payer : {invoice.amount_residual:.0f} {invoice.currency_id.symbol}\n\n"
                wave_message += f"Cliquez sur le lien ci-dessous pour payer avec Wave :\n\n"
                wave_message += f"{invoice.payment_link_wave}\n\n"
                wave_message += "â”€" * 30 + "\n"
                wave_message += "Ã‰quipe CCBM Shop"
                
                try:
                    result = message.config_id.send_text_to_partner(
                        partner_id=invoice.partner_id.id,
                        message_text=wave_message
                    )
                    
                    if result and isinstance(result, dict) and result.get('success'):
                        _logger.info("Lien de paiement Wave envoyÃ© (message texte) pour la facture %s", invoice.name)
                        message.content = f"Lien Wave facture {invoice.name} envoyÃ©"
                    else:
                        _logger.warning("Ã‰chec de l'envoi du lien Wave pour la facture %s", invoice.name)
                        message.content = f"Ã‰chec envoi lien Wave: {result.get('error', 'Erreur inconnue') if result else 'Aucun rÃ©sultat'}"
                except Exception as e2:
                    _logger.exception("Erreur lors de l'envoi du message texte Wave pour la facture %s", invoice.name)
                    message.content = f"Erreur envoi: {str(e2)}"
        else:
            _logger.warning("Configuration WhatsApp non trouvÃ©e pour envoyer le lien Wave")
            message.content = "Configuration WhatsApp non trouvÃ©e"
    else:
        _logger.warning("Aucun lien de paiement Wave disponible pour la facture %s", invoice.name)
        message.content = "Lien Wave non disponible"
else:
    _logger.warning("Aucune facture trouvÃ©e pour paiement Wave via WhatsApp - Bouton: %s, NumÃ©ro: %s", button_id, message.phone)
    message.content = "Aucune facture trouvÃ©e"
]]></field>
        <field name="sequence">11</field>
        <field name="active">True</field>
        <field name="description">Envoie le lien de paiement Wave lorsque le client clique sur "Payer avec Wave"</field>
    </record>
    
    <!-- Action pour envoyer le lien de paiement Orange Money -->
    <record id="action_btn_pay_orange" model="whatsapp.button.action">
        <field name="name">Payer avec Orange Money</field>
        <field name="button_id">btn_pay_orange</field>
        <field name="action_type">custom_python</field>
        <field name="python_code"><![CDATA[
# Extrait l'ID de la facture depuis le button_id
invoice_id = None
invoice = None

# Le button_id est au format "btn_pay_orange_123" oÃ¹ 123 est l'ID de la facture
if button_id and button_id.startswith('btn_pay_orange_'):
    try:
        invoice_id_str = button_id.replace('btn_pay_orange_', '')
        invoice_id = int(invoice_id_str)
        invoice = env['account.move'].browse(invoice_id)
        if not invoice.exists():
            invoice = None
            _logger.warning("Facture avec ID %s n'existe pas (button_id: %s)", invoice_id, button_id)
        else:
            _logger.info("Facture trouvÃ©e par ID: %s (button_id: %s)", invoice.name, button_id)
    except ValueError as e:
        _logger.warning("Impossible de convertir l'ID de facture depuis button_id %s: %s", button_id, str(e))
        invoice = None
    except Exception as e:
        _logger.warning("Erreur lors de la recherche de facture par ID depuis button_id %s: %s", button_id, str(e))
        invoice = None

# Si pas trouvÃ© par ID, cherche par numÃ©ro de tÃ©lÃ©phone du partenaire
if not invoice:
    phone_clean = message.phone.replace(' ', '').replace('-', '').replace('.', '')
    if not phone_clean.startswith('+'):
        phone_clean = '+' + phone_clean.lstrip('+')
    
    invoice = env['account.move'].search([
        ('partner_id.phone', 'ilike', phone_clean),
        ('move_type', 'in', ['out_invoice', 'out_refund']),
        ('state', '=', 'posted'),
        ('amount_residual', '>', 0)
    ], order='create_date desc', limit=1)

if invoice:
    # VÃ©rifie si les attributs de paiement existent
    has_payment_links = hasattr(invoice, 'payment_link_wave') and hasattr(invoice, 'payment_link_orange_money')
    
    # S'assure que le lien Orange Money existe si les attributs sont disponibles
    payment_link_orange = None
    if has_payment_links:
        if hasattr(invoice, '_ensure_payment_links'):
            invoice._ensure_payment_links()
        elif not getattr(invoice, 'payment_link_orange_money', None):
            if hasattr(invoice, 'transaction_id') and invoice.transaction_id:
                base_url = env['ir.config_parameter'].sudo().get_param('web.base.url', '')
                invoice.payment_link_orange_money = f"{base_url}/paiement?type=orange&transaction={invoice.transaction_id}"
        
        payment_link_orange = getattr(invoice, 'payment_link_orange_money', None)
    
    if payment_link_orange:
        # Essaie d'abord d'utiliser un template WhatsApp avec bouton URL
        # Si le template n'est pas disponible, utilise un message texte
        if message.config_id:
            try:
                # Essaie d'envoyer avec le template "paiement_orange"
                components = [
                    {
                        "type": "body",
                        "parameters": [
                            {"type": "text", "text": invoice.name},  # {{1}} - NumÃ©ro facture
                            {"type": "text", "text": f"{invoice.amount_residual:.0f}"},  # {{2}} - Montant
                            {"type": "text", "text": invoice.currency_id.symbol or "CFA"}  # {{3}} - Devise
                        ]
                    },
                    {
                        "type": "button",
                        "sub_type": "url",
                        "index": "0",  # Index du premier bouton (0-based)
                        "parameters": [
                            {
                                "type": "text",
                                "text": invoice.payment_link_orange_money  # {{4}} - URL de paiement
                            }
                        ]
                    }
                ]
                
                result = message.config_id.send_template_message(
                    to_phone=message.phone,
                    template_name="paiement_orange",
                    language_code="fr",
                    components=components
                )
                
                if result and isinstance(result, dict) and result.get('success'):
                    _logger.info("Template paiement_orange envoyÃ© avec succÃ¨s pour la facture %s", invoice.name)
                    message.content = f"Template Orange facture {invoice.name} envoyÃ©"
                else:
                    raise Exception("Template non disponible ou erreur")
                    
            except Exception as e:
                _logger.info("Template paiement_orange non disponible, utilisation message texte: %s", str(e))
                # Fallback : message texte avec lien cliquable
                orange_message = f"ðŸ’³ Paiement Orange Money pour la facture {invoice.name}\n\n"
                orange_message += f"Montant Ã  payer : {invoice.amount_residual:.0f} {invoice.currency_id.symbol}\n\n"
                orange_message += f"Cliquez sur le lien ci-dessous pour payer avec Orange Money :\n\n"
                orange_message += f"{invoice.payment_link_orange_money}\n\n"
                orange_message += "â”€" * 30 + "\n"
                orange_message += "Ã‰quipe CCBM Shop"
                
                try:
                    result = message.config_id.send_text_to_partner(
                        partner_id=invoice.partner_id.id,
                        message_text=orange_message
                    )
                    
                    if result and isinstance(result, dict) and result.get('success'):
                        _logger.info("Lien de paiement Orange Money envoyÃ© (message texte) pour la facture %s", invoice.name)
                        message.content = f"Lien Orange Money facture {invoice.name} envoyÃ©"
                    else:
                        _logger.warning("Ã‰chec de l'envoi du lien Orange Money pour la facture %s", invoice.name)
                        message.content = f"Ã‰chec envoi lien Orange Money: {result.get('error', 'Erreur inconnue') if result else 'Aucun rÃ©sultat'}"
                except Exception as e2:
                    _logger.exception("Erreur lors de l'envoi du message texte Orange pour la facture %s", invoice.name)
                    message.content = f"Erreur envoi: {str(e2)}"
        else:
            _logger.warning("Configuration WhatsApp non trouvÃ©e pour envoyer le lien Orange Money")
            message.content = "Configuration WhatsApp non trouvÃ©e"
    else:
        _logger.warning("Aucun lien de paiement Orange Money disponible pour la facture %s", invoice.name)
        message.content = "Lien Orange Money non disponible"
else:
    _logger.warning("Aucune facture trouvÃ©e pour paiement Orange Money via WhatsApp - Bouton: %s, NumÃ©ro: %s", button_id, message.phone)
    message.content = "Aucune facture trouvÃ©e"
]]></field>
        <field name="sequence">12</field>
        <field name="active">True</field>
        <field name="description">Envoie le lien de paiement Orange Money lorsque le client clique sur "Payer avec Orange Money"</field>
    </record>
</odoo>

