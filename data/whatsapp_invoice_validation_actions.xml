<?xml version="1.0" encoding="utf-8"?>
<!-- whatsapp_business_api/data/whatsapp_invoice_validation_actions.xml -->
<odoo>
    <!-- Action pour valider une facture (gère les IDs dynamiques comme btn_validate_invoice_123) -->
    <record id="action_btn_validate_invoice" model="whatsapp.button.action">
        <field name="name">Valider facture</field>
        <field name="button_id">btn_validate_invoice</field>
        <field name="action_type">custom_python</field>
        <field name="python_code"><![CDATA[
import json
import logging

_logger = logging.getLogger(__name__)

# Cherche la facture par ID dans le button_id
invoice = None
invoice_id = None

# Le button_id est au format "btn_validate_invoice_123" où 123 est l'ID de la facture
if button_id.startswith('btn_validate_invoice_'):
    try:
        invoice_id = int(button_id.replace('btn_validate_invoice_', ''))
        invoice = env['account.move'].browse(invoice_id)
        if not invoice.exists():
            invoice = None
    except:
        pass

# Si pas trouvé par ID, cherche par numéro de téléphone et facture récente
if not invoice:
    # Cherche dans les messages précédents pour trouver l'ID de la facture
    previous_messages = env['whatsapp.message'].search([
        ('phone', '=', message.phone),
        ('direction', '=', 'out'),
        ('message_type', '=', 'interactive')
    ], order='create_date desc', limit=5)
    
    for prev_msg in previous_messages:
        if prev_msg.raw_payload:
            try:
                payload = json.loads(prev_msg.raw_payload)
                interactive = payload.get('interactive', {})
                buttons = interactive.get('action', {}).get('buttons', [])
                for btn in buttons:
                    btn_id = btn.get('reply', {}).get('id', '')
                    if btn_id.startswith('btn_validate_invoice_'):
                        try:
                            invoice_id = int(btn_id.replace('btn_validate_invoice_', ''))
                            invoice = env['account.move'].browse(invoice_id)
                            if invoice.exists():
                                break
                        except:
                            pass
                if invoice:
                    break
            except:
                pass

# Si pas trouvé, cherche par numéro de téléphone du partenaire
if not invoice:
    phone_clean = message.phone.replace(' ', '').replace('-', '').replace('.', '')
    if not phone_clean.startswith('+'):
        phone_clean = '+' + phone_clean.lstrip('+')
    
    invoice = env['account.move'].search([
        ('partner_id.phone', 'ilike', phone_clean),
        ('x_whatsapp_validation_sent', '=', True),
        ('move_type', 'in', ['out_invoice', 'out_refund']),
        ('state', 'not in', ['cancel', 'draft'])
    ], order='create_date desc', limit=1)

if invoice:
    # Valide la facture (passe à l'état "posted" si ce n'est pas déjà le cas)
    if invoice.state == 'draft':
        invoice.action_post()
    
    # Marque la facture comme validée
    invoice.write({
        'x_whatsapp_validation_sent': True,
    })
    
    # Envoie un message de confirmation
    if message.config_id:
        try:
            message.config_id.send_text_message(
                message.phone,
                f"✅ Facture {invoice.name} validée avec succès !\n\nMontant : {invoice.amount_total:.0f} F CFA\n\nMerci de votre confiance."
            )
        except:
            pass
    
    # Log
    _logger.info("Facture %s validée via WhatsApp par %s", invoice.name, message.phone)
    message.content = f"Facture {invoice.name} validée"
else:
    _logger.warning("Aucune facture trouvée pour validation via WhatsApp - Numéro: %s", message.phone)
    message.content = "Aucune facture trouvée pour validation"
]]></field>
        <field name="sequence">30</field>
        <field name="active">True</field>
        <field name="description">Valide une facture lorsque le client clique sur "Valider"</field>
    </record>

    <!-- Action pour rejeter une facture (gère les IDs dynamiques comme btn_reject_invoice_123) -->
    <record id="action_btn_reject_invoice" model="whatsapp.button.action">
        <field name="name">Rejeter facture</field>
        <field name="button_id">btn_reject_invoice</field>
        <field name="action_type">custom_python</field>
        <field name="python_code"><![CDATA[
import json
import logging

_logger = logging.getLogger(__name__)

# Cherche la facture par ID dans le button_id
invoice = None
invoice_id = None

# Le button_id est au format "btn_reject_invoice_123" où 123 est l'ID de la facture
if button_id.startswith('btn_reject_invoice_'):
    try:
        invoice_id = int(button_id.replace('btn_reject_invoice_', ''))
        invoice = env['account.move'].browse(invoice_id)
        if not invoice.exists():
            invoice = None
    except:
        pass

# Si pas trouvé par ID, cherche par numéro de téléphone et facture récente
if not invoice:
    # Cherche dans les messages précédents pour trouver l'ID de la facture
    previous_messages = env['whatsapp.message'].search([
        ('phone', '=', message.phone),
        ('direction', '=', 'out'),
        ('message_type', '=', 'interactive')
    ], order='create_date desc', limit=5)
    
    for prev_msg in previous_messages:
        if prev_msg.raw_payload:
            try:
                payload = json.loads(prev_msg.raw_payload)
                interactive = payload.get('interactive', {})
                buttons = interactive.get('action', {}).get('buttons', [])
                for btn in buttons:
                    btn_id = btn.get('reply', {}).get('id', '')
                    if btn_id.startswith('btn_reject_invoice_') or btn_id.startswith('btn_validate_invoice_'):
                        try:
                            invoice_id = int(btn_id.replace('btn_reject_invoice_', '').replace('btn_validate_invoice_', ''))
                            invoice = env['account.move'].browse(invoice_id)
                            if invoice.exists():
                                break
                        except:
                            pass
                if invoice:
                    break
            except:
                pass

# Si pas trouvé, cherche par numéro de téléphone du partenaire
if not invoice:
    phone_clean = message.phone.replace(' ', '').replace('-', '').replace('.', '')
    if not phone_clean.startswith('+'):
        phone_clean = '+' + phone_clean.lstrip('+')
    
    invoice = env['account.move'].search([
        ('partner_id.phone', 'ilike', phone_clean),
        ('x_whatsapp_validation_sent', '=', True),
        ('move_type', 'in', ['out_invoice', 'out_refund']),
        ('state', 'not in', ['cancel', 'draft'])
    ], order='create_date desc', limit=1)

if invoice:
    # Annule la facture
    if invoice.state != 'cancel':
        invoice.button_draft()
        invoice.button_cancel()
    
    # Envoie un message de confirmation
    if message.config_id:
        try:
            message.config_id.send_text_message(
                message.phone,
                f"❌ Facture {invoice.name} rejetée.\n\nN'hésitez pas à nous contacter si vous avez des questions ou souhaitez modifier votre facture."
            )
        except:
            pass
    
    # Log
    _logger.info("Facture %s rejetée via WhatsApp par %s", invoice.name, message.phone)
    message.content = f"Facture {invoice.name} rejetée"
else:
    _logger.warning("Aucune facture trouvée pour rejet via WhatsApp - Numéro: %s", message.phone)
    message.content = "Aucune facture trouvée pour rejet"
]]></field>
        <field name="sequence">40</field>
        <field name="active">True</field>
        <field name="description">Rejette une facture lorsque le client clique sur "Rejeter"</field>
    </record>
</odoo>

