<?xml version="1.0" encoding="utf-8"?>
<!-- whatsapp_business_api/data/whatsapp_order_details_actions.xml -->
<odoo>
    <!-- Action pour afficher les d√©tails d'une commande avec les produits -->
    <record id="action_btn_view_order_details" model="whatsapp.button.action">
        <field name="name">Voir d√©tail commande</field>
        <field name="button_id">btn_view_order_details</field>
        <field name="action_type">custom_python</field>
        <field name="python_code"><![CDATA[
# Cherche la commande par ID dans le button_id
order = None
order_id = None

# Le button_id est au format "btn_view_order_details_123" o√π 123 est l'ID de la commande
if button_id and button_id.startswith('btn_view_order_details_'):
    try:
        order_id_str = button_id.replace('btn_view_order_details_', '')
        order_id = int(order_id_str)
        order = env['sale.order'].browse(order_id)
        if not order.exists():
            order = None
            _logger.warning("Commande avec ID %s n'existe pas (button_id: %s)", order_id, button_id)
        else:
            _logger.info("Commande trouv√©e par ID: %s (button_id: %s)", order.name, button_id)
    except ValueError as e:
        _logger.warning("Impossible de convertir l'ID de commande depuis button_id %s: %s", button_id, str(e))
        order = None
    except Exception as e:
        _logger.warning("Erreur lors de la recherche de commande par ID depuis button_id %s: %s", button_id, str(e))
        order = None

# Si pas trouv√© par ID, cherche par num√©ro de t√©l√©phone et commande r√©cente
if not order:
    # Cherche dans les messages pr√©c√©dents pour trouver l'ID de la commande
    previous_messages = env['whatsapp.message'].search([
        ('phone', '=', message.phone),
        ('direction', '=', 'out'),
        ('message_type', '=', 'interactive')
    ], order='create_date desc', limit=5)
    
    for prev_msg in previous_messages:
        if prev_msg.raw_payload:
            try:
                payload = json.loads(prev_msg.raw_payload)
                interactive = payload.get('interactive', {})
                buttons = interactive.get('action', {}).get('buttons', [])
                for btn in buttons:
                    btn_id = btn.get('reply', {}).get('id', '')
                    if btn_id.startswith('btn_view_order_details_'):
                        try:
                            order_id = int(btn_id.replace('btn_view_order_details_', ''))
                            order = env['sale.order'].browse(order_id)
                            if order.exists():
                                break
                        except:
                            pass
                if order:
                    break
            except:
                pass

# Si pas trouv√©, cherche par num√©ro de t√©l√©phone du partenaire
if not order:
    phone_clean = message.phone.replace(' ', '').replace('-', '').replace('.', '')
    if not phone_clean.startswith('+'):
        phone_clean = '+' + phone_clean.lstrip('+')
    
    order = env['sale.order'].search([
        ('partner_id.phone', 'ilike', phone_clean),
        ('x_whatsapp_creation_sent', '=', True)
    ], order='create_date desc', limit=1)

if order:
    # V√©rifie si les d√©tails ont d√©j√† √©t√© envoy√©s (√©vite les doublons)
    if order.x_whatsapp_details_sent:
        _logger.info("D√©tails de la commande %s d√©j√† envoy√©s, envoi ignor√©", order.name)
        message.content = f"D√©tails commande {order.name} d√©j√† envoy√©s"
    else:
        # Construit le message avec les d√©tails de la commande
        details_message = f"üìã D√©tails de la commande {order.name}\n\n"
        
        # Informations g√©n√©rales
        details_message += f"Client : {order.partner_id.name if order.partner_id else 'N/A'}\n"
        details_message += f"Num√©ro : {order.name}\n"
        details_message += f"Date : {order.date_order.strftime('%d/%m/%Y') if order.date_order else 'N/A'}\n"
        details_message += f"Montant total : {order.amount_total:.0f} F CFA\n\n"
        
        # Type de commande si disponible
        if hasattr(order, 'type_sale') and order.type_sale:
            type_sale_translations = {
                'order': 'Commande',
                'preorder': 'Pr√©commande',
                'creditorder': 'Commande cr√©dit'
            }
            type_sale_display = type_sale_translations.get(order.type_sale, order.type_sale)
            details_message += f"Type : {type_sale_display}\n\n"
        
        # Liste des produits
        if order.order_line:
            details_message += "üì¶ Produits :\n"
            details_message += "‚îÄ" * 30 + "\n"
            
            for line in order.order_line:
                product_name = line.product_id.name if line.product_id else line.name
                quantity = line.product_uom_qty
                unit_price = line.price_unit
                subtotal = line.price_subtotal
                
                # Formate le nom du produit (limite √† 30 caract√®res pour WhatsApp)
                if len(product_name) > 30:
                    product_name = product_name[:27] + "..."
                
                details_message += f"‚Ä¢ {product_name}\n"
                details_message += f"  Qt√© : {quantity:.0f}"
                
                # Affiche l'unit√© si disponible
                if line.product_uom:
                    details_message += f" {line.product_uom.name}"
                
                details_message += f" √ó {unit_price:.0f} F CFA\n"
                details_message += f"  Sous-total : {subtotal:.0f} F CFA\n\n"
        else:
            details_message += "üì¶ Aucun produit dans cette commande.\n\n"
        
        # Totaux
        details_message += "‚îÄ" * 30 + "\n"
        details_message += f"Sous-total : {order.amount_untaxed:.0f} F CFA\n"
        
        if order.amount_tax > 0:
            details_message += f"TVA : {order.amount_tax:.0f} F CFA\n"
        
        details_message += f"Total : {order.amount_total:.0f} F CFA\n\n"
        
        # Informations suppl√©mentaires
        if order.partner_id.street:
            details_message += f"üìç Adresse : {order.partner_id.street}\n"
            if order.partner_id.city:
                details_message += f"   {order.partner_id.city}"
                if order.partner_id.zip:
                    details_message += f" {order.partner_id.zip}"
                details_message += "\n"
        
        # Envoie le message de d√©tails
        if message.config_id:
            try:
                result = message.config_id.send_text_to_partner(
                    partner_id=order.partner_id.id,
                    message_text=details_message
                )
                
                # Marque la commande comme ayant re√ßu les d√©tails uniquement si l'envoi a r√©ussi
                if result and isinstance(result, dict) and result.get('success'):
                    from odoo import fields
                    order.write({
                        'x_whatsapp_details_sent': True,
                        'x_whatsapp_details_sent_date': fields.Datetime.now()
                    })
                    _logger.info("D√©tails de la commande %s envoy√©s via WhatsApp √† %s", order.name, message.phone)
                    message.content = f"D√©tails commande {order.name} envoy√©s"
                else:
                    _logger.warning("√âchec de l'envoi des d√©tails de la commande %s: %s", order.name, result.get('error', 'Erreur inconnue') if result else 'Aucun r√©sultat')
                    message.content = f"√âchec envoi d√©tails: {result.get('error', 'Erreur inconnue') if result else 'Aucun r√©sultat'}"
            except Exception as e:
                _logger.error("Erreur lors de l'envoi des d√©tails de la commande %s: %s", order.name, str(e))
                message.content = f"Erreur envoi d√©tails: {str(e)}"
        else:
            _logger.warning("Configuration WhatsApp non trouv√©e pour envoyer les d√©tails de la commande")
            message.content = "Configuration WhatsApp non trouv√©e"
else:
    _logger.warning("Aucune commande trouv√©e pour afficher les d√©tails via WhatsApp - Bouton: %s, Num√©ro: %s", button_id, message.phone)
    message.content = "Aucune commande trouv√©e"
]]></field>
        <field name="sequence">5</field>
        <field name="active">True</field>
        <field name="description">Affiche les d√©tails d'une commande avec la liste des produits lorsque le client clique sur "Voir d√©tail"</field>
    </record>
</odoo>

