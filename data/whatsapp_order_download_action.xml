<?xml version="1.0" encoding="utf-8"?>
<!-- Action pour t√©l√©charger le PDF d'une commande -->
<odoo>
    <record id="action_btn_download_order" model="whatsapp.button.action">
        <field name="name">T√©l√©charger PDF commande</field>
        <field name="button_id">btn_download_order</field>
        <field name="action_type">custom_python</field>
        <field name="python_code"><![CDATA[
import base64

# Extrait l'ID de la commande depuis le button_id
order_id = None
order = None

# Le button_id est au format "btn_download_order_123" o√π 123 est l'ID de la commande
if button_id and button_id.startswith('btn_download_order_'):
    try:
        order_id_str = button_id.replace('btn_download_order_', '')
        order_id = int(order_id_str)
        order = env['sale.order'].browse(order_id)
        if not order.exists():
            order = None
            _logger.warning("Commande avec ID %s n'existe pas (button_id: %s)", order_id, button_id)
        else:
            _logger.info("Commande trouv√©e par ID: %s (button_id: %s)", order.name, button_id)
    except ValueError as e:
        _logger.warning("Impossible de convertir l'ID de commande depuis button_id %s: %s", button_id, str(e))
        order = None
    except Exception as e:
        _logger.warning("Erreur lors de la recherche de commande par ID depuis button_id %s: %s", button_id, str(e))
        order = None

# Si pas trouv√© par ID, cherche par num√©ro de t√©l√©phone du partenaire
if not order:
    phone_clean = message.phone.replace(' ', '').replace('-', '').replace('.', '')
    if not phone_clean.startswith('+'):
        phone_clean = '+' + phone_clean.lstrip('+')
    
    order = env['sale.order'].search([
        ('partner_id.phone', 'ilike', phone_clean),
        ('x_whatsapp_creation_sent', '=', True)
    ], order='create_date desc', limit=1)

if order:
    try:
        # Essaie plusieurs m√©thodes pour trouver le rapport
        report = None
        report_names = ['sale.report_saleorder', 'sale.action_report_saleorder']
        
        for report_name in report_names:
            try:
                report = env['ir.actions.report']._get_report_from_name(report_name)
                if report and report.exists() and report.id:
                    break
                else:
                    report = None
            except:
                report = None
                continue
        
        if not report or not report.exists():
            report = env['ir.actions.report'].search([
                ('report_name', 'in', report_names),
                ('model', '=', 'sale.order')
            ], limit=1)
        
        if report and report.exists():
            # G√©n√®re le PDF
            pdf_content, _unused = report._render_qweb_pdf(order.id)
            
            if pdf_content:
                # Cr√©e un attachment public pour le PDF
                attachment = env['ir.attachment'].create({
                    'name': f"{order.name}.pdf",
                    'type': 'binary',
                    'datas': base64.b64encode(pdf_content),
                    'res_model': 'sale.order',
                    'res_id': order.id,
                    'public': True,  # Important : rend le fichier accessible publiquement
                })
                
                # G√©n√®re l'URL publique de t√©l√©chargement
                base_url = env['ir.config_parameter'].sudo().get_param('web.base.url')
                pdf_url = f"{base_url}/web/content/{attachment.id}?download=true"
                
                # Envoie le message avec le lien de t√©l√©chargement
                if message.config_id:
                    download_message = f"üìÑ T√©l√©charger le PDF de votre commande {order.name}\n\n"
                    download_message += f"Cliquez sur le lien ci-dessous pour t√©l√©charger :\n"
                    download_message += f"{pdf_url}\n\n"
                    download_message += f"Montant : {order.amount_total:.0f} {order.currency_id.symbol if order.currency_id else 'F CFA'}\n\n"
                    download_message += "‚îÄ" * 30 + "\n"
                    download_message += "√âquipe CCBM Shop"
                    
                    result = message.config_id.send_text_to_partner(
                        partner_id=order.partner_id.id,
                        message_text=download_message
                    )
                    
                    if result and isinstance(result, dict) and result.get('success'):
                        _logger.info("Lien de t√©l√©chargement envoy√© pour la commande %s", order.name)
                        message.content = f"Lien PDF commande {order.name} envoy√©"
                    else:
                        _logger.warning("√âchec de l'envoi du lien de t√©l√©chargement pour la commande %s", order.name)
                        message.content = f"√âchec envoi lien PDF commande {order.name}"
                else:
                    _logger.warning("Configuration WhatsApp non trouv√©e pour envoyer le lien de t√©l√©chargement")
                    message.content = "Configuration WhatsApp non trouv√©e"
            else:
                _logger.warning("Impossible de g√©n√©rer le PDF pour la commande %s", order.name)
                message.content = f"Erreur g√©n√©ration PDF commande {order.name}"
        else:
            _logger.warning("Aucun rapport trouv√© pour g√©n√©rer le PDF de la commande %s", order.name)
            message.content = f"Rapport PDF non trouv√© pour commande {order.name}"
    except Exception as e:
        _logger.error("Erreur lors de la g√©n√©ration et envoi du PDF pour la commande %s: %s", order.name, str(e))
        message.content = f"Erreur g√©n√©ration PDF: {str(e)}"
else:
    _logger.warning("Aucune commande trouv√©e pour t√©l√©chargement via WhatsApp - Bouton: %s, Num√©ro: %s", button_id, message.phone)
    message.content = "Aucune commande trouv√©e"
]]></field>
        <field name="sequence">6</field>
        <field name="active">True</field>
        <field name="description">Envoie le lien de t√©l√©chargement du PDF de la commande (devis) lorsque le client clique sur "T√©l√©charger PDF"</field>
    </record>
</odoo>

