<?xml version="1.0" encoding="utf-8"?>
<!-- Actions de boutons pour la validation/annulation de commande avec ID dans le button_id -->
<odoo>
    <!-- Action pour valider une commande -->
    <record id="action_btn_validate_order_v2" model="whatsapp.button.action">
        <field name="name">Validation de commande (avec ID)</field>
        <field name="button_id">btn_validate_order</field>
        <field name="action_type">custom_python</field>
        <field name="python_code"><![CDATA[
# Extrait l'ID de la commande depuis le button_id
order_id = None
order = None

# Le button_id est au format "btn_validate_order_123" où 123 est l'ID de la commande
if button_id and button_id.startswith('btn_validate_order_'):
    try:
        order_id_str = button_id.replace('btn_validate_order_', '')
        order_id = int(order_id_str)
        order = env['sale.order'].browse(order_id)
        if not order.exists():
            order = None
            _logger.warning("Commande avec ID %s n'existe pas (button_id: %s)", order_id, button_id)
        else:
            _logger.info("Commande trouvée par ID: %s (button_id: %s)", order.name, button_id)
    except ValueError as e:
        _logger.warning("Impossible de convertir l'ID de commande depuis button_id %s: %s", button_id, str(e))
        order = None
    except Exception as e:
        _logger.warning("Erreur lors de la recherche de commande par ID depuis button_id %s: %s", button_id, str(e))
        order = None

# Si pas trouvé par ID, cherche par numéro de téléphone du partenaire
if not order:
    phone_clean = message.phone.replace(' ', '').replace('-', '').replace('.', '')
    if not phone_clean.startswith('+'):
        phone_clean = '+' + phone_clean.lstrip('+')
    
    order = env['sale.order'].search([
        ('partner_id.phone', 'ilike', phone_clean),
        ('x_whatsapp_creation_sent', '=', True),
        ('x_whatsapp_validated', '=', False),
        ('x_whatsapp_rejected', '=', False),
        ('state', 'not in', ['cancel', 'done'])
    ], order='create_date desc', limit=1)

if order:
    # Vérifie si la commande a déjà été validée
    if order.x_whatsapp_validated:
        _logger.info("Commande %s déjà validée, action ignorée", order.name)
        message.content = f"Commande {order.name} déjà validée"
    else:
        # Met à jour l'état de la commande en "sale" (confirmé)
        order.write({
            'state': 'sale',
            'x_whatsapp_validated': True,
        })
        
        # Envoie un message de confirmation
        if message.config_id:
            try:
                confirmation_message = f"✅ Votre commande {order.name} a été validée avec succès !\n\n"
                confirmation_message += f"Montant total : {order.amount_total:.0f} F CFA\n\n"
                confirmation_message += "Merci de votre confiance."
                
                result = message.config_id.send_text_to_partner(
                    partner_id=order.partner_id.id,
                    message_text=confirmation_message
                )
                
                if result and isinstance(result, dict) and result.get('success'):
                    _logger.info("Message de confirmation de validation envoyé pour la commande %s", order.name)
                else:
                    _logger.warning("Échec de l'envoi du message de confirmation pour la commande %s", order.name)
            except Exception as e:
                _logger.error("Erreur lors de l'envoi du message de confirmation pour la commande %s: %s", order.name, str(e))
        
        _logger.info("Commande %s validée via WhatsApp par %s", order.name, message.phone)
        message.content = f"Commande {order.name} validée"
else:
    _logger.warning("Aucune commande trouvée pour validation via WhatsApp - Bouton: %s, Numéro: %s", button_id, message.phone)
    message.content = "Aucune commande trouvée pour validation"
]]></field>
        <field name="sequence">5</field>
        <field name="active">True</field>
        <field name="description">Valide une commande de vente lorsque le client clique sur "Valider" (avec ID dans le button_id)</field>
    </record>

    <!-- Action pour annuler une commande -->
    <record id="action_btn_cancel_order_v2" model="whatsapp.button.action">
        <field name="name">Annulation de commande (avec ID)</field>
        <field name="button_id">btn_cancel_order</field>
        <field name="action_type">custom_python</field>
        <field name="python_code"><![CDATA[
# Extrait l'ID de la commande depuis le button_id
order_id = None
order = None

# Le button_id est au format "btn_cancel_order_123" où 123 est l'ID de la commande
if button_id and button_id.startswith('btn_cancel_order_'):
    try:
        order_id_str = button_id.replace('btn_cancel_order_', '')
        order_id = int(order_id_str)
        order = env['sale.order'].browse(order_id)
        if not order.exists():
            order = None
            _logger.warning("Commande avec ID %s n'existe pas (button_id: %s)", order_id, button_id)
        else:
            _logger.info("Commande trouvée par ID: %s (button_id: %s)", order.name, button_id)
    except ValueError as e:
        _logger.warning("Impossible de convertir l'ID de commande depuis button_id %s: %s", button_id, str(e))
        order = None
    except Exception as e:
        _logger.warning("Erreur lors de la recherche de commande par ID depuis button_id %s: %s", button_id, str(e))
        order = None

# Si pas trouvé par ID, cherche par numéro de téléphone du partenaire
if not order:
    phone_clean = message.phone.replace(' ', '').replace('-', '').replace('.', '')
    if not phone_clean.startswith('+'):
        phone_clean = '+' + phone_clean.lstrip('+')
    
    order = env['sale.order'].search([
        ('partner_id.phone', 'ilike', phone_clean),
        ('x_whatsapp_creation_sent', '=', True),
        ('x_whatsapp_validated', '=', False),
        ('x_whatsapp_rejected', '=', False),
        ('state', 'not in', ['cancel', 'done'])
    ], order='create_date desc', limit=1)

if order:
    # Vérifie si la commande a déjà été annulée
    if order.x_whatsapp_rejected or order.state == 'cancel':
        _logger.info("Commande %s déjà annulée, action ignorée", order.name)
        message.content = f"Commande {order.name} déjà annulée"
    else:
        # Met à jour l'état de la commande en "cancel" (annulé)
        order.write({
            'state': 'cancel',
            'x_whatsapp_rejected': True,
        })
        
        # Envoie un message de confirmation
        if message.config_id:
            try:
                confirmation_message = f"❌ Votre commande {order.name} a été annulée.\n\n"
                confirmation_message += "Si vous avez des questions ou souhaitez modifier votre commande, n'hésitez pas à nous contacter."
                
                result = message.config_id.send_text_to_partner(
                    partner_id=order.partner_id.id,
                    message_text=confirmation_message
                )
                
                if result and isinstance(result, dict) and result.get('success'):
                    _logger.info("Message de confirmation d'annulation envoyé pour la commande %s", order.name)
                else:
                    _logger.warning("Échec de l'envoi du message de confirmation pour la commande %s", order.name)
            except Exception as e:
                _logger.error("Erreur lors de l'envoi du message de confirmation pour la commande %s: %s", order.name, str(e))
        
        _logger.info("Commande %s annulée via WhatsApp par %s", order.name, message.phone)
        message.content = f"Commande {order.name} annulée"
else:
    _logger.warning("Aucune commande trouvée pour annulation via WhatsApp - Bouton: %s, Numéro: %s", button_id, message.phone)
    message.content = "Aucune commande trouvée pour annulation"
]]></field>
        <field name="sequence">6</field>
        <field name="active">True</field>
        <field name="description">Annule une commande de vente lorsque le client clique sur "Annuler" (avec ID dans le button_id)</field>
    </record>
</odoo>

